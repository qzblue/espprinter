{% extends "base.html" %}

{% block content %}
<section class="card">
  <h1>主要使用者排行</h1>
  <p>依照時間與條件篩選，查看每台機器與跨機器教師的列印 / 影印量。</p>
  <form method="get" class="form-grid">
    <label>
      <span>視圖模式</span>
      <select name="view_mode" id="view-mode-select">
        <option value="all_printers" {% if view_mode=="all_printers" %}selected{% endif %}>所有列印機</option>
        <option value="single_printer" {% if view_mode=="single_printer" %}selected{% endif %}>單台列印機</option>
        <option value="aggregated" {% if view_mode=="aggregated" %}selected{% endif %}>跨列印機匯總</option>
      </select>
    </label>
    <label id="printer-selector" {% if view_mode !="single_printer" %}style="display: none;" {% endif %}>
      <span>列印機</span>
      <select name="printer">
        {% for printer in printer_choices %}
        <option value="{{ printer.value }}" {% if query.printer==printer.value %}selected{% endif %}>{{ printer.label }}
        </option>
        {% endfor %}
      </select>
    </label>
    <label>
      <span>用戶 / 登入關鍵字</span>
      <input type="text" name="user" value="{{ query.user }}" placeholder="例如zzy或朱振宇" />
    </label>
    <label>
      <span>工作模式</span>
      <select name="mode">
        <option value="" {% if not query.mode %}selected{% endif %}>全部</option>
        <option value="列印" {% if query.mode=="列印" %}selected{% endif %}>列印</option>
        <option value="影印" {% if query.mode=="影印" %}selected{% endif %}>影印</option>
        <option value="掃描" {% if query.mode=="掃描" %}selected{% endif %}>掃描</option>
      </select>
    </label>
    <label>
      <span>電腦名稱</span>
      <input type="text" name="computer" value="{{ query.computer }}" />
    </label>
    <label>
      <span>時間範圍模式</span>
      <select name="time_mode" class="time-mode-select">
        <option value="all" {% if query.time_mode=="all" %}selected{% endif %}>全部資料</option>
        <option value="month" {% if query.time_mode=="month" %}selected{% endif %}>指定月份</option>
        <option value="week" {% if query.time_mode=="week" %}selected{% endif %}>指定週</option>
        <option value="custom" {% if query.time_mode=="custom" %}selected{% endif %}>自訂時間</option>
      </select>
    </label>
    <label class="time-field" data-time-field="month">
      <span>指定月份</span>
      <input type="month" name="month" value="{{ query.month }}" />
    </label>
    <label class="time-field" data-time-field="week">
      <span>指定週 (YYYY-Www)</span>
      <input type="text" name="week" value="{{ query.week }}" placeholder="2026-W05" />
    </label>
    <label class="time-field" data-time-field="custom">
      <span>開始時間</span>
      <input type="datetime-local" name="start" value="{{ query.start }}" />
    </label>
    <label class="time-field" data-time-field="custom">
      <span>結束時間</span>
      <input type="datetime-local" name="end" value="{{ query.end }}" />
    </label>

    <div style="grid-column: 1 / -1; display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap">
      <button type="submit" class="btn">套用篩選</button>
      <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: auto;">
        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; white-space: nowrap">
          <span>導出範圍:</span>
          <select id="export-scope-select" style="margin: 0">
            <option value="current_filter">當前篩選 ({% if pagination %}{{ pagination.total_users }} {% if view_mode ==
              'all_printers' %}筆記錄{% else %}位用戶{% endif %}{% else %}0{% endif %})</option>
            <option value="all_data">全部資料</option>
          </select>
        </label>
        <a class="btn" id="export-btn"
          href="{{ url_for('export_leaders') }}{% if query_string %}?{{ query_string }}&{% else %}?{% endif %}export_range=current_filter">導出
          Excel</a>
      </div>
    </div>
    <div style="grid-column: 1 / -1; margin-top: 1rem; color: #dc2626; font-weight: bold; text-align: center;">
      <i class="fas fa-exclamation-circle"></i> 注意：請務必點擊「套用篩選」按鈕以獲取正確數據！
    </div>
  </form>
</section>

{% if errors %}
<section class="card error">
  {% for err in errors %}
  <div>{{ err }}</div>
  {% endfor %}
</section>
{% endif %}

<section class="card">
  <h2>排行榜 {% if view_mode == "single_printer" and rows %}<span class="tag">{{ rows[0].printer }}</span>{% endif %}</h2>

  <p>符合 {{ totals.jobs }} 筆，共 {{ totals.pages }} 張 (黑白 {{ totals.bw }} / 彩色 {{ totals.color }})。</p>

  <table>
    <thead>
      <tr>
        <th>用戶</th>
        <th>筆數</th>
        <th>張數</th>
        {% if show_printer_column %}
        <th>列印機</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for item in rows %}
      <tr>
        <td>
          {{ item.user | user_display_name }}
          {% if item.login and item.login != item.user %}
          <div style="font-size: 0.85rem; color: #6b7280">{{ item.login }}</div>
          {% endif %}
        </td>
        <td>{{ item.jobs }}</td>
        <td>{{ item.pages }}<br /><small>黑白 {{ item.bw }} / 彩色 {{ item.color }}</small></td>
        {% if show_printer_column %}
        <td>{{ item.printer_label }}</td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if pagination and pagination.total_pages > 1 %}
  <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; align-items: center;">
    {% if pagination.has_prev %}
    <a class="btn"
      href="{{ url_for('leaders', view_mode=view_mode, page=pagination.prev_num, per_page=pagination.per_page, printer=query.printer, user=query.user, mode=query.mode, computer=query.computer, time_mode=query.time_mode, month=query.month, week=query.week, start=query.start, end=query.end) }}">上一頁</a>
    {% else %}
    <button class="btn" disabled style="background: #ccc; cursor: not-allowed">上一頁</button>
    {% endif %}

    <span style="color: #666; font-size: 0.9rem;">第 {{ pagination.page }} / {{ pagination.total_pages }} 頁
      {% if view_mode == 'all_printers' %}
      ({{ pagination.total_users }} 筆記錄 / {{ pagination.total_unique_users }} 位用戶)
      {% else %}
      ({{ pagination.total_users }} 位用戶)
      {% endif %}
    </span>

    {% if pagination.has_next %}
    <a class="btn"
      href="{{ url_for('leaders', view_mode=view_mode, page=pagination.next_num, per_page=pagination.per_page, printer=query.printer, user=query.user, mode=query.mode, computer=query.computer, time_mode=query.time_mode, month=query.month, week=query.week, start=query.start, end=query.end) }}">下一頁</a>
    {% else %}
    <button class="btn" disabled style="background: #ccc; cursor: not-allowed">下一頁</button>
    {% endif %}
  </div>
  {% endif %}
</section>

<script>
  // Handle view mode changes to show/hide printer selector
  document.addEventListener('DOMContentLoaded', function () {
    const viewModeSelect = document.getElementById('view-mode-select');
    const printerSelector = document.getElementById('printer-selector');

    if (viewModeSelect && printerSelector) {
      viewModeSelect.addEventListener('change', function () {
        if (this.value === 'single_printer') {
          printerSelector.style.display = '';
        } else {
          printerSelector.style.display = 'none';
        }
      });
    }

    // Handle time mode visibility (existing functionality)
    const timeModeSelect = document.querySelector('.time-mode-select');
    if (timeModeSelect) {
      const updateTimeFieldVisibility = () => {
        const mode = timeModeSelect.value;
        document.querySelectorAll('.time-field').forEach(field => {
          const fieldType = field.dataset.timeField;
          field.style.display = (mode === fieldType) ? '' : 'none';
        });
      };
      timeModeSelect.addEventListener('change', updateTimeFieldVisibility);
      updateTimeFieldVisibility();
    }

    // Handle export range selection
    const exportBtn = document.getElementById('export-btn');
    const exportScopeSelect = document.getElementById('export-scope-select');
    if (exportBtn && exportScopeSelect) {
      exportScopeSelect.addEventListener('change', function () {
        const currentHref = exportBtn.href;
        const url = new URL(currentHref);
        url.searchParams.set('export_range', this.value);
        exportBtn.href = url.toString();
      });
    }
  });
</script>
{% endblock %}