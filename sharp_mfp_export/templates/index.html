{% extends "base.html" %}

{% block content %}
<section class="card">
  <h1>校內列印機查詢控制台</h1>
  <p>
    透過這個系統，我們可以快速檢視支持用戶認證的聖保祿校内Sharp列印機的使用情況。<br />
    點選下方按鈕即可進入對應的查詢工具或執行數據更新。
  </p>
  <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem">
    <a class="btn" href="{{ url_for('counts') }}">查看用戶統計</a>
    <a class="btn" href="{{ url_for('jobs') }}">查看列印紀錄</a>
    <a class="btn" href="{{ url_for('leaders') }}">查看主要使用者</a>
    <button class="btn" id="update-btn" style="background: #059669"><i class="fas fa-sync"></i> 立即更新數據</button>
  </div>
</section>

<section class="card">
  <h2>已設定的列印機</h2>
  <ul>
    {% for printer in printer_choices %}
    <li>
      <strong>{{ printer.label }}</strong>
      <span class="tag">{{ printer.value }}</span>
    </li>
    {% endfor %}
  </ul>
</section>

<section class="card">
  <h2>使用教程</h2>
  <ol>
    <li><strong>自動更新機制</strong>：系統會在<strong>每天下午 6 點</strong>自動抓取最新數據，通常情況下無需手動操作。</li>
    <li><strong>手動更新 (Fallback)</strong>：僅在自動更新失敗或數據異常時才需使用上方按鈕手動更新。此操作需要授權密碼，請洽詢<strong>教學資訊科技部</strong>。</li>
    <li><strong>功能介紹</strong>：
      <ul>
        <li><a href="{{ url_for('counts') }}">查看用戶統計</a>：檢視每位用戶的累積張數與配額使用狀況。</li>
        <li><a href="{{ url_for('jobs') }}">查看列印紀錄</a>：查詢詳細的列印/影印工作流水帳。</li>
        <li><a href="{{ url_for('leaders') }}">查看主要使用者</a>：快速統計印量最高的前幾名用戶。</li>
      </ul>
    </li>
    <li><strong>數據匯出</strong>：在所有報表頁面的右下角，均可點擊 <strong>Excel 匯出</strong> 下載當前報表。</li>
  </ol>
  <p style="margin-top: 1rem; font-size: 0.95rem; color: #666;">
    <i class="fas fa-info-circle"></i> 提示：若發現今日數據尚未更新，請先檢查下方的「最近更新紀錄」。
  </p>
</section>



<section class="card">
  <h2>最近更新紀錄</h2>
  <style>
    .log-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .log-table th,
    .log-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #f3f4f6;
    }

    .log-table th {
      color: #6b7280;
      font-weight: 500;
      font-size: 0.85rem;
    }

    .badge {
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.75rem;
      display: inline-block;
    }

    .badge.success {
      color: #059669;
      background: #ecfdf5;
    }

    .badge.error {
      color: #dc2626;
      background: #fef2f2;
    }

    .badge.running {
      color: #d97706;
      background: #fffbeb;
    }
  </style>
  <table class="log-table">
    <thead>
      <tr>
        <th>時間</th>
        <th>來源</th>
        <th>狀態</th>
        <th>訊息</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td style="color: #374151;">{{ log.start_time.strftime('%m-%d %H:%M') }}</td>
        <td>
          <span style="color: #6b7280; font-size: 0.85rem;">
            {{ '自動排程' if log.trigger_source == 'auto' else '手動更新' }}
          </span>
        </td>
        <td>
          {% if log.status == 'success' %}
          <span class="badge success">成功</span>
          {% elif log.status == 'error' %}
          <span class="badge error">失敗</span>
          {% else %}
          <span class="badge running">執行中</span>
          {% endif %}
        </td>
        <td style="color: #4b5563;">{{ log.message }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="4" style="text-align: center; color: #9ca3af; padding: 1rem;">暫無更新紀錄</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<!-- Progress Modal -->
<div id="progress-modal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <h3 style="margin-top: 0; color: #b91c1c;"><i class="fas fa-exclamation-triangle"></i> 正在更新數據...</h3>
    <p style="font-weight: bold;">請勿關閉此視窗，否則可能導致數據遺失！</p>

    <div class="progress-container">
      <div id="progress-bar" class="progress-bar">0%</div>
    </div>

    <div id="status-text" style="margin-bottom: 0.5rem; font-weight: 500;">準備中...</div>
    <div id="log-output" class="log-area"></div>

    <div style="margin-top: 1.5rem; text-align: right;">
      <button id="close-modal-btn" class="btn" style="background: #6b7280; display: none;">關閉</button>
    </div>
  </div>
</div>

<style>
  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .progress-container {
    width: 100%;
    background-color: #e5e7eb;
    border-radius: 9999px;
    height: 1.5rem;
    overflow: hidden;
    margin: 1.5rem 0;
  }

  .progress-bar {
    height: 100%;
    background-color: #2563eb;
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .log-area {
    background: #1f2937;
    color: #e5e7eb;
    padding: 1rem;
    border-radius: 8px;
    height: 150px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.85rem;
    margin-top: 1rem;
  }
</style>

<script>
  document.getElementById('update-btn').addEventListener('click', function () {
    const modal = document.getElementById('progress-modal');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');
    const logOutput = document.getElementById('log-output');
    const closeBtn = document.getElementById('close-modal-btn');

    const password = prompt("請輸入更新密碼：", "");
    if (password === null) {
      // User cancelled
      return;
    }

    // Reset state
    modal.style.display = 'flex';
    progressBar.style.width = '0%';
    progressBar.innerText = '0%';
    logOutput.innerHTML = '';
    closeBtn.style.display = 'none';

    // Simulation config
    let progress = 0;
    const targetDuration = 300 * 1000; // 5 minutes (300 seconds)
    const intervalTime = 500; // Update every 500ms
    const steps = targetDuration / intervalTime;
    const increment = 98 / steps; // Aim for 98% in 300s

    const timer = setInterval(() => {
      if (progress < 98) {
        progress += increment;
        if (progress > 98) progress = 98;
        const rounded = Math.floor(progress);
        progressBar.style.width = rounded + '%';
        progressBar.innerText = rounded + '%';
      }
    }, intervalTime);

    // Prevent closing
    window.onbeforeunload = function () {
      return "數據更新中，確定要離開嗎？";
    };

    const es = new EventSource('/update_data?token=' + encodeURIComponent(password));

    es.onmessage = function (event) {
      const data = JSON.parse(event.data);

      if (data.status === 'start') {
        statusText.innerText = data.message;
      } else if (data.status === 'progress') {
        statusText.innerText = data.message;
        // Backend progress events just update text, don't jump the bar to avoid jerkiness
        // unless necessary. We rely on the simulation for the main visual.

        const p = document.createElement('div');
        p.innerText = '> ' + data.message;
        p.style.color = '#60a5fa';
        logOutput.appendChild(p);
        logOutput.scrollTop = logOutput.scrollHeight;

      } else if (data.status === 'log') {
        const p = document.createElement('div');
        p.innerText = data.message;
        logOutput.appendChild(p);
        logOutput.scrollTop = logOutput.scrollHeight;

      } else if (data.status === 'done') {
        clearInterval(timer); // Stop simulation
        es.close();
        window.onbeforeunload = null;

        // Force 100%
        progressBar.style.width = '100%';
        progressBar.innerText = '100%';
        progressBar.style.backgroundColor = '#059669';
        statusText.innerText = data.message;
        closeBtn.style.display = 'inline-block';
        // Alert removed as requested

      } else if (data.status === 'error') {
        clearInterval(timer);
        es.close();
        window.onbeforeunload = null;
        progressBar.style.backgroundColor = '#dc2626';
        statusText.innerText = "錯誤: " + data.message;
        statusText.style.color = '#dc2626';
        closeBtn.style.display = 'inline-block';
        alert(data.message);
      }
    };

    es.onerror = function () {
      clearInterval(timer);
      es.close();
      window.onbeforeunload = null;
      statusText.innerText = "連線中斷或發生錯誤";
      closeBtn.style.display = 'inline-block';
    };

    closeBtn.onclick = function () {
      modal.style.display = 'none';
      location.reload(); // Reload to reflect new data
    };
  });
</script>
{% endblock %}